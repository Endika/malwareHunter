from PyQt4.QtCore import QCoreApplication, QThread
from bottle import *
from beaker.middleware import SessionMiddleware

session_opts = {
    'session.type': 'file',
    'session.cookie_expires': 300,
    'session.data_dir': './.sessions',
    'session.auto': True
}

TEMPLATE_PATH.insert(0, 'template')
webapp = SessionMiddleware(app(), session_opts)

@route('/static/<path:path>')
def static(path):
    return static_file(path, 'template/static/')

##### / #####
@route('/')
def index():
	if (request.environ.get('beaker.session').get('email', "") == ""): redirect("/login")
	return template('index',user="")

@post('/')
def index():
	import time
	time.sleep(15)
	if (request.environ.get('beaker.session').get('email', "") == ""): redirect("/login")
	return template('index',user="")

##### /login #####
@route('/login')
def login():
	if (request.environ.get('beaker.session').get('email', "") != ""): redirect("/")
	return template('login')

@post('/login')
def login():
	email = request.forms.get('email')
	password = request.forms.get('password')
	if (request.environ.get('beaker.session').get('email', "") != ""): redirect("/")
	if(email != "") and (password == "admin"):
		s = request.environ.get('beaker.session')
		s['email'] = email
		s.save()
		return template('index',user=email)
	else:
		return template('login',)

##### /logout #####
@route('/logout')
def logout():
	if (request.environ.get('beaker.session').get('email', "") == ""): redirect("/login")
	else :
		s = request.environ.get('beaker.session')
		del s["email"]
		s.save()
		redirect("/login")

##### /quit #####
@route('/quit')
def index():
    QCoreApplication.instance().quit()

#################
class WebApp(QThread):
    def __init__(self):
        QThread.__init__(self)

    def run(self):
        run(webapp, host='localhost', port=8080, quiet=True)
